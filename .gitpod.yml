# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/config-gitpod-file)
# and commit this file to your remote git repository to share the goodness with others.

tasks:
  - env: &common_env
      application_port: &app_port 1350
      staging_port: &staging_port 1358
      pg_dbname: karaokemugen_server
      pg_user: karaokemugen_server
      pg_password: "70ebadce-be85-49ad-8ac7-04a342014df9"
      default_karaokebase_url: "https://gitlab.com/karaokemugen/bases/karaokebase"
  - name: Serve staging repository over http
    env:
      <<: *common_env
    command: |
      python3 -m http.server "$staging_port" --directory app/staging/
  - name: Prepare postgres DB
    env:
      <<: *common_env
    command: |
      bash .gitpod/startDb.sh
      sleep 5s
      docker exec -it db psql "postgresql://$pg_user:$pg_password@localhost:5432/$pg_dbname"
  - name: Run project
    env: 
      <<: *common_env
      SENTRY_TEST: true
    before: |
      sudo install-packages uuid-runtime
    init: |
      bash .gitpod/gitSubmoduleFallback.sh
      bash .gitpod/cloneKaraokebase.sh
      bash .gitpod/createAppConfig.sh
    command: |
      sudo install-packages ffmpeg
      bash .gitpod/setupApp.sh
      yarn start:dev

ports:
  - port: *app_port
    visibility: public
  - port: *staging_port
    visibility: public